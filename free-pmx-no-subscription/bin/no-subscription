#!/bin/bash

# SPDX-License-Identifier: AGPL-3.0-only

echo
echo "free-pmx: NO-SUBSCRIPTION - 'No Subscription' Repositories Setup"
trap "echo" EXIT

declare -i status=0

source "/usr/lib/free-pmx/no-subscription-common" 2> /dev/null \
|| { echo "Internal error, aborting." >&2; exit 1; }

init "FREE_PMX_NO_SUBSCRIPTION" "$@"

{ declare_aptsrcs; declare -i err=$?; }
(( err & 1 )) && { echo "Cannot gather necessary system information, aborting." >&2; exit 1; }

{ declare -A todo_id_flags; for i in "${ORD_APTSRC_IDS[@]}"; do todo_id_flags["$i"]=0; done; }

if [[ -n $O_TARGET ]]; then
    (( ${#ARGS[@]} == 0 )) \
    || { echo "Arguments not allowed when used with '-t' option." >&2; exit 1; }

    declare list_id_match=''

    for i in "${!APTSRC_TARGETS[@]}"; do
        [[ $O_TARGET == "${APTSRC_TARGETS["$i"]}" ]] \
        && { list_id_match="$i"; todo_id_flags["$i"]=1; break; }
    done

    if [[ -n $list_id_match ]]; then
        echo "Explicit target recognised as $list_id_match: $O_TARGET"
    else
        { echo "No defined repositories for this target." >&2; exit 1; }
    fi
elif (( ${#ARGS[@]} > 0 )); then
    for arg in "${ARGS[@]}"; do
        case "$arg" in
            pve|pbs|pmg|ceph) todo_id_flags["$arg"]=1;;
            *) { echo "Invalid argument: $arg" >&2; exit 1; };;
        esac
    done
else
    echo -n "Detecting default sources ..."
    for i in "${ORD_APTSRC_IDS[@]}"; do
        [[ -f ${APTSRC_TARGETS["$i"]} ]] && todo_id_flags["$i"]=1 && echo -n " $i"
    done
    echo        
fi

{ todo_count=0; for i in "${ORD_APTSRC_IDS[@]}"; do (( todo_count+=todo_id_flags[$i] )); done; }
done_count=0

if (( todo_count > 0 )); then
    (( todo_id_flags["ceph"] == 1 )) && [[ -z $FREE_PMX_CEPH ]] \
    && { todo_id_flags["ceph"]=0; echo "Ceph codename not configured, skipping ..." >&2; }

    for i in "${ORD_APTSRC_IDS[@]}"; do
        (( todo_id_flags["$i"] == 1 )) \
        && echo "Setting up for $i ..." \
        && run_rl_replace "${APTSRC_TARGETS["$i"]}" "${APTSRC_TEMPLS["$i"]}" \
        && (( done_count++ ))
    done
    (( done_count != todo_count )) && status=1

    echo "Completed total $done_count of $todo_count."
    echo

    echo "Checking for Proxmox release key: $FREE_PMX_APTKEY_LOCAL ..."
    run_rk_check "$FREE_PMX_APTKEY_LOCAL" "$FREE_PMX_APTKEY_ORIGIN" \
    || { echo "Failed Proxmox release key check." >&2; status=1; }
else
    echo "Nothing to be set up."
fi

(( O_AUTORUN == 0 )) && (( done_count > 0 )) && cat << 'EOF'

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
NOTICE: Do not forget to perform UPDATE and UPGRADE, e.g.:
    apt update
    apt full-upgrade
EOF

(( O_AUTORUN == 0 )) && cat << 'EOF'

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Visit <https://free-pmx.pages.dev/tools/free-pmx-no-subscription/>
for more details, to check the latest version or to report an issue.
EOF

exit $status
