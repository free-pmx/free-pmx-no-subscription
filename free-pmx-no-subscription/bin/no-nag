#!/bin/bash

# SPDX-FileCopyrightText: Copyright 2025 free-pmx
# SPDX-License-Identifier: AGPL-3.0-only

declare -i status=0

source "/usr/lib/free-pmx/no-subscription-common" \
    && init_out \
    || exit 255

print OUT
print OUT "free-pmx: NO-NAG - 'No Subscription' Nags Removal"
trap 'print OUT' EXIT

init_run "FREE_PMX_NO_NAG" "$@"

declare_nn_globals || {
    print ERR "Warning: Issues parsing some patch definitions."
}

((${#ARGS[@]} == 0)) || {
    print ERR "Arguments not supported."
    exit 1
}

declare -a targets=()
if [[ -n $O_TARGET ]]; then
    print OUT "Explicit target specified."
    targets+=("$O_TARGET")
else
    targets+=("${PATCHDEF_TARGET_LIST[@]}")
fi

declare -i no_file_count=0 no_effect_count=0
declare -ra bak_ext_variants=(bak original)
declare target
for target in "${targets[@]}"; do
    if [[ -f "$target" ]] || [[ -n "$O_TARGET" ]]; then
        print OUT "Patches applicable to: $target ..."

        declare -a todo_ids=()
        IFS=';' read -r -a todo_ids <<< "${PATCHDEF_TARGET_TO_IDS[$target]}"

        ((${#todo_ids[@]} == 0)) && {
            print ERR "No patch definitions for this target."
            ((status |= 1))
        }

        declare -i i
        for i in "${!todo_ids[@]}"; do
            declare bak_ext=''
            ((i)) || bak_ext="${bak_ext_variants[$O_AUTORUN]}"

            run_patchdef_apply "${PATCHDEF_DIR}/${todo_ids[$i]}.patchdef" "$bak_ext"
            declare -i err=$?
            ! ((err & 2)) || ((no_file_count++))
            ! ((err & 8)) || ((no_effect_count++))
        done
    fi
done

! ((O_AUTORUN)) && ((no_file_count > 0)) \
    && print ERR $'\e' << EOF

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
NOTICE: Some ($no_file_count) patch attempt(s) with target file NOT FOUND.

It is EXPECTED when running the command MANUALLY with explicit target file ('-t')
that does not exist as not all products are likely installed (PVE, PBS, PMG).
EOF

! ((O_AUTORUN)) && ((no_effect_count > 0)) \
    && print ERR $'\e' << EOF

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
NOTICE: Some ($no_effect_count) patch(es) had NO EFFECT.

It is EXPECTED when running the command MANUALLY and also after e.g. RE-INSTALL
of the free-pmx package during an automated run.

If you are still experiencing undesired artefacts in the web interface,
consider REFRESHING (CTRL+F5) your BROWSER or confirm the issue with ANOTHER.
EOF

! ((O_AUTORUN)) \
    && print ERR $'\e' << EOF

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Visit $NS_WEB
for more details, to check the latest version or to report an issue.
EOF

exit $((status))
